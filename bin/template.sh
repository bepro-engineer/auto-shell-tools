#!/bin/sh
#_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/
#
# Usage:
#     template.sh [ 作成スクリプト名 ] 
#     #  sh template.sh test
# Description:
#     引数で指定されたShellスクリプトのテンプレートを作成する。l
#
# Design documents
#     None
#
#_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/
# ＜変更履歴＞
# Ver. 変更管理No. 日付        更新者       変更内容
# 1.0  PR-0001    2019/01/16 Bepro       新規作成
#_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/

# 引数チェック
if [ $# -lt 1 ]; then
  echo "[ERROR] Missing argument: Please specify the name of the script to create."
  echo "Usage: $0 <script_name>"
  exit 1
fi

# スクリプト名の取得
SCRIPT_NAME=$1

# "template" を含む名前は禁止
if echo "$SCRIPT_NAME" | grep -q -e 'template'; then
  echo "[ERROR] Invalid script name: The name cannot contain the word 'template'."
  exit 1
fi

# スクリプトファイルのパス
SCRIPT_FILE="./${SCRIPT_NAME}.sh"

# カレントディレクトリの書き込み権限を確認
if [ ! -w . ]; then
  echo "[ERROR] The current directory is not writable. Cannot create files here."
  exit 1
fi

# スクリプトファイルの重複チェック
if [ -f "$SCRIPT_FILE" ]; then
  echo "[ERROR] The file '$SCRIPT_FILE' already exists."
  exit 1
fi

# ----------------------------------------------------------
# テンプレート内容をスクリプトファイルに書き込む
# ----------------------------------------------------------
cat << EOF > "$SCRIPT_FILE"
#!/bin/sh
#_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/
#
# Usage:
#    SCRIPT_NAME.sh
# 
# Description:
#    This script is auto-generated by template.sh.
#
# Design documents
#    None
#
#_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/
# ＜変更履歴＞
# Ver. 変更管理No. 日付        更新者       変更内容
#_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/
. "\$(dirname "\$0")/../com/logger.shrc"
. "\$(dirname "\$0")/../com/utils.shrc"
#runAs       root \$*
#setLANG     utf-8

# Job status codes
JOB_OK=0  # Normal exit
JOB_WR=1  # Warning exit
JOB_ER=2  # Error exit
rc=JOB_ER

# ----------------------------------------------------------
# functions terminate
# ----------------------------------------------------------
terminate() {
  releaseLock
}

# ----------------------------------------------------------
# functions checkArgs
# ----------------------------------------------------------
checkArgs() {
  :
}

# ----------------------------------------------------------
# functions checkConf
# ----------------------------------------------------------
checkConf() {
  :
}

# ====== サンプルテンプレート設定ファイルの作成 ======

# ETC_PATH が未設定ならデフォルトパスを設定
if [ -z "\$ETC_PATH" ]; then
  ETC_PATH="/etc"
fi

# 必要ならディレクトリを作成
mkdir -p "\$ETC_PATH"

# サンプル設定ファイルの作成（既存のものはバックアップ）
TEMPLATE_FILE="\$ETC_PATH/template.cfg"

if [ -f "\$TEMPLATE_FILE" ]; then
  mv "\$TEMPLATE_FILE" "\${TEMPLATE_FILE}.bak_\$(date +%Y%m%d%H%M%S)"
fi

cat <<EOT > "\$TEMPLATE_FILE"
# テンプレート設定ファイル
テンプレート設定ファイル１ # サンプル
テンプレート設定ファイル２ # サンプル
EOT

# ----------------------------------------------------------
# pre-process
# ----------------------------------------------------------
scope="pre"

hostname=$(hostname -s)
os=$(uname -s)
temp_list="\$TEMPLATE_FILE"  # 作成された設定ファイルを temp_list にセット

startLog

logOut "INFO" args: ["\$@"]

if acquireLock; then
  logOut "INFO" successfully locked.
else
  abort could not acquire lock.
fi

trap "terminate" 0 1 2 3 15

checkArgs \$*
# ----------------------------------------------------------
# main-routine
# ----------------------------------------------------------
scope="main"

# 設定ファイルが存在するか確認
if [ ! -f "\$temp_list" ]; then
    logOut "ERROR" "Configuration file not found: \$temp_list"
    exitLog \$JOB_ER
fi

# Loop processing of target worth.
sed '/^#/d;/^[[:blank:]]*$/d' "\$temp_list" | while IFS= read -r line; do
    echo "DEBUG: Line read - [\$line]"
    logOut "DEBUG" "Loop started turn of [ \$line ]."

    if [ \$? -ne 0 ]; then
        logOut "ERROR" "Failed to [ \$line ]."
        exitLog \$JOB_ER
    fi
done

if [ \$? -eq 0 ]; then
  rc=\$JOB_OK
fi
# ----------------------------------------------------------
# post-process
# ----------------------------------------------------------
scope="post"

exitLog \$rc
EOF

# 作成後にスクリプト名を置換
sed -i "s/SCRIPT_NAME/${SCRIPT_NAME}/g" "$SCRIPT_FILE"
# ----------------------------------------------------------
# テンプレートの書き込み終了
# ----------------------------------------------------------

# ファイル作成の成功判定
if [ $? -ne 0 ]; then
  echo "[ERROR] Failed to create the template file '$SCRIPT_FILE'."
  exit 1
fi

# ファイルの存在確認（念のため）
if [ ! -f "$SCRIPT_FILE" ]; then
  echo "[ERROR] Template file '$SCRIPT_FILE' does not exist after creation."
  exit 1
fi

# ファイルの実行権限を付与
chmod +x "$SCRIPT_FILE"

# 実行権限の付与に失敗した場合
if [ $? -ne 0 ]; then
  echo "[ERROR] Failed to set executable permissions on '$SCRIPT_FILE'."
  exit 1
fi

# 成功メッセージ
echo "Template script '$SCRIPT_FILE' has been created successfully."